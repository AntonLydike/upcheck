<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>UpCheck - Uptime Check Tool</title>
  <style>
    .histogram {
      display: flex;
      height: 4rem;
      gap: 3px;
    }
    .bar {
      flex: 1;
      border-radius: 3px;
      height: calc(var(--size, 1) * 100%);
    }
    .bar.gray {
      height: 100%;
    }
    .bar.gray   { background-color: #dadddf; } /* no data */
    .bar.green  { background-color: #28a745; } /* good */
    .bar.orange { background-color: #fd7e14; } /* warning */
    .bar.red    { background-color: #dc3545; } /* critical */
    .bi {
        line-height: 1;
        vertical-align: -.125em;
    }
    @media (max-width: 800px) {
        .histogram {
            gap: 0;
        }
        .bar {
            border-radius: 0px;
        }
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script defer data-domain="upcheck.datenvorr.at" src="https://plausible.datenvorr.at/js/script.outbound-links.pageview-props.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">

  <div class="mb-5 d-flex justify-content-between flex-wrap align-items-end">
    <h1>Service Uptime Dashboard</h1>
    <form class="d-flex align-items-end gap-2 flex-wrap" id="report-range">
      <!-- End Date -->
      <div>
        <label for="endDate" class="form-label mb-1 small">End</label>
        <div class="d-flex gap-2">
          <input type="date" class="form-control form-control-sm" name="end_date" required value="{{ end_time.date().isoformat() }}" max="{{ end_time.date().isoformat() }}">
          <input type="time" class="form-control form-control-sm" name="end_time" value="{{ end_time.time().strftime('%H:%M') }}" max="{{ end_time.time().strftime('%H:%M') }}">
        </div>
      </div>

      <!-- Duration -->
      <div>
        <label for="durationValue" class="form-label mb-1 small">Duration</label>
        <div class="d-flex input-group input-group-sm">
          <input type="number" min="1" class="form-control" id="durationValue" name="duration_value" value="1" required style="max-width: 70px;">
          <select class="form-select" id="durationUnit" name="duration_unit" required style="max-width: 95px;">
            <option value="m">min</option>
            <option value="h">hour</option>
            <option value="d" selected>day</option>
          </select>
        </div>
      </div>

      <!-- Buckets -->
      <div>
        <label for="buckets" class="form-label mb-1 small">Buckets</label>
        <input type="number" min="1" max="96" class="form-control form-control-sm" id="buckets" name="buckets" value="{{ buckets }}" required style="max-width: 70px;">
      </div>

      <!-- Submit -->
      <div class="d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-sm btn-primary">Search</button>
        <a class="btn btn-sm btn-warning" href="/">Reset</a>
      </div>

      <!-- Hidden field to detect form spammers -->
       <div class="d-none">
        <label for="buckets" class="form-label mb-1 small">UUID</label>
        <input type="text" name="uuid" id="uuid-input">
       </div>
    </form>
  </div>

  {% for name, service in data.items() %}
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h3 class="card-title">
        {{ name }}
        <a href="{{ service.url }}" target="_blank" title="Visit Website">
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5"/>
            <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
        </svg>
        </a>
      </h3>

      <!-- Uptime Histogram -->
      <h6 class="mt-3">Uptime</h6>

      <div class="histogram align-items-end">
        {% for up, time in service.hist_uptime|zip(time_buckets) %}
          <div class="bar {{ uptime_to_color(up, service.uptime_goal) }}" style="--size: {{ up }}" x-time="{{time}}" x-value="{{'%.0f'|format(up*100)}}%" title="{{time}}: {{'%.0f'|format(up*100)}}%"></div>
        {% endfor %}
      </div>

      <!-- Axis Names -->
      <div class="d-flex justify-content-between">
          <small class="text-muted"><time datetime="{{ start_time }}">{{ start_time }}</time></small>
          <small class="text-muted"><time datetime="{{ end_time }}">{{ end_time }}</time></small>
      </div>

      <!-- Latency Histogram -->
      <div class="histogram align-items-start">
        {% for lat, time in service.hist_latency|zip(time_buckets) %}
        <div class="bar {{ lat_to_color(lat, service.latency_geomean_max) }}" style="--size: {{ lat / service.latency_geomean_max }}" x-time="{{time}}" x-value="{{lat|duration('No Data') }}" title="{{time}}: {{ lat|duration('No Data') }}"></div>
        {% endfor %}
      </div>
      <h6 class="mt-2">Latency (geomean)</h6>

      <!-- Stats -->
      <div class="mt-4 d-flex justify-content-between flex-wrap">
        <p><strong>Uptime (period):</strong> {{ '%.2f'|format(service.uptime * 100) }}%</p>
        <p><strong>Uptime (total):</strong> {{ '%.2f'|format(service.total_uptime * 100) }}%</p>
        <p><strong>Goal:</strong> >{{ '%.2f'|format(service.uptime_goal * 100) }}%</p>
        <p><strong>Latency (max):</strong> {{ service.latency_max|duration }}</p>
        <p><strong>Latency (geomean):</strong> {{ service.latency_geomean|duration }}</p>
      </div>
    </div>
  </div>
  {% endfor %}

  <footer class="text-muted mt-5 d-flex justify-content-between">
    <small>&copy; Copyright 2025 - Anton Lydike</small>
    <small>Served in {{ time | duration }}</small>
    <small>Powered by <a href="https://github.com/antonlydike/upcheck">UpCheck</a></small>
  </footer>
  </div>
  <script>document.querySelectorAll('time[datetime]').forEach(t => {
    t.innerText = (new Date(t.getAttribute('datetime'))).toLocaleString(undefined, {dateStyle: "short", timeStyle: "short"});
  })

  document.querySelectorAll('.bar[x-time][x-value]').forEach(elm => {
    const t = new Date(elm.getAttribute('x-time'));
    const val = elm.getAttribute('x-value');
    elm.setAttribute('title', `${t.toLocaleString(undefined, {dateStyle: "short", timeStyle: "short"})}: ${val}`);
  })
  document.querySelector('#report-range').addEventListener('formdata', e=> {
    const data = e.formData;
    if (data.get('end_time')) {
      data.append(
        'end', `${data.get('end_date')} ${data.get('end_time')}`
      );
    } else {
      data.append(
        'end', data.get('end_date')
      );
    }
    data.append(
      'duration', `${data.get('duration_value')}${data.get('duration_unit')}`
    );

    ['duration_value', 'duration_unit', 'end_date', 'end_time', 'uuid'].map(f => data.delete(f));
  })
  document.querySelector('input[name=end_date]').addEventListener('change', e => {
    const t = document.querySelector('input[name=end_time]');
    t.value = "00:00";
    t.focus();
  })
  </script>
  </body>
  </html>